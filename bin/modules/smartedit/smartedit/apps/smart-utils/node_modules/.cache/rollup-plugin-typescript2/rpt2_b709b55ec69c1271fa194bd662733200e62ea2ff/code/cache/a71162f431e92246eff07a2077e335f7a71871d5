{"code":"import { __decorate, __metadata, __param } from \"tslib\";\r\n/*\r\n * Copyright (c) 2021 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { EVENT_SERVICE, REAUTH_STARTED, WHO_AM_I_RESOURCE_URI_TOKEN } from '../../../constants';\r\nimport { IAuthenticationService } from '../../../interfaces';\r\nimport { HttpUtils, PromiseUtils } from '../../../utils';\r\n// map used by HttpAuthInterceptor to avoid replay identical requests being held because of 401\r\nexport var GET_REQUESTS_ON_HOLD_MAP = {};\r\n/**\r\n * @ngdoc service\r\n * @name @smartutils.services:unauthorizedErrorInterceptor\r\n * @description\r\n * Used for HTTP error code 401 (Forbidden). It will display the login modal.\r\n */\r\nvar UnauthorizedErrorInterceptor = /** @class */ (function () {\r\n    function UnauthorizedErrorInterceptor(httpClient, authenticationService, promiseUtils, httpUtils, WHO_AM_I_RESOURCE_URI, eventService) {\r\n        this.httpClient = httpClient;\r\n        this.authenticationService = authenticationService;\r\n        this.promiseUtils = promiseUtils;\r\n        this.httpUtils = httpUtils;\r\n        this.eventService = eventService;\r\n        this.promisesToResolve = {}; // key: auth entry point, value: array of deferred\r\n        this.rejectedUrls = [/authenticate/];\r\n        this.rejectedUrls.push(WHO_AM_I_RESOURCE_URI);\r\n    }\r\n    UnauthorizedErrorInterceptor.prototype.predicate = function (request, response) {\r\n        return (response.status === 401 &&\r\n            (request.url\r\n                ? this.httpUtils.isCRUDRequest(request, response) &&\r\n                    this.isUrlNotRejected(request.url)\r\n                : true));\r\n    };\r\n    UnauthorizedErrorInterceptor.prototype.responseError = function (request, response) {\r\n        var _this = this;\r\n        var deferred = this.promiseUtils.defer();\r\n        var deferredPromise = deferred.promise.then(function () {\r\n            return _this.httpClient.request(request).toPromise();\r\n        });\r\n        this.authenticationService.isAuthEntryPoint(request.url).then(function (isAuthEntryPoint) {\r\n            if (!isAuthEntryPoint) {\r\n                _this.authenticationService\r\n                    .filterEntryPoints(request.url)\r\n                    .then(function (entryPoints) {\r\n                    var entryPoint = entryPoints[0];\r\n                    _this.promisesToResolve[entryPoint] =\r\n                        _this.promisesToResolve[entryPoint] || [];\r\n                    _this.promisesToResolve[entryPoint].push({\r\n                        requestIdentifier: request.url,\r\n                        deferred: deferred\r\n                    });\r\n                    if (_this.httpUtils.isGET(request)) {\r\n                        GET_REQUESTS_ON_HOLD_MAP[request.url] = deferredPromise;\r\n                    }\r\n                    _this.authenticationService\r\n                        .isReAuthInProgress(entryPoint)\r\n                        .then(function (isReAuthInProgress) {\r\n                        if (!isReAuthInProgress) {\r\n                            _this.authenticationService\r\n                                .setReAuthInProgress(entryPoint)\r\n                                .then(function () {\r\n                                var promisesToResolve = _this.promisesToResolve;\r\n                                _this.eventService.publish(REAUTH_STARTED);\r\n                                _this.authenticationService\r\n                                    .authenticate(request.url)\r\n                                    .then(function () {\r\n                                    promisesToResolve[this].forEach(function (record) {\r\n                                        delete GET_REQUESTS_ON_HOLD_MAP[record.requestIdentifier];\r\n                                        record.deferred.resolve();\r\n                                    });\r\n                                    promisesToResolve[this] = [];\r\n                                }.bind(entryPoint), function () {\r\n                                    promisesToResolve[this].forEach(function (record) {\r\n                                        delete GET_REQUESTS_ON_HOLD_MAP[record.requestIdentifier];\r\n                                        record.deferred.reject();\r\n                                    });\r\n                                    promisesToResolve[this] = [];\r\n                                }.bind(entryPoint));\r\n                            });\r\n                        }\r\n                    });\r\n                });\r\n            }\r\n            else {\r\n                deferred.reject(response);\r\n            }\r\n        });\r\n        return deferredPromise;\r\n    };\r\n    UnauthorizedErrorInterceptor.prototype.isUrlNotRejected = function (url) {\r\n        return !this.rejectedUrls.some(function (rejectedUrl) {\r\n            return typeof rejectedUrl === 'string' ? url.indexOf(rejectedUrl) === 0 : rejectedUrl.test(url);\r\n        });\r\n    };\r\n    UnauthorizedErrorInterceptor = __decorate([\r\n        Injectable(),\r\n        __param(4, Inject(WHO_AM_I_RESOURCE_URI_TOKEN)),\r\n        __param(5, Inject(EVENT_SERVICE)),\r\n        __metadata(\"design:paramtypes\", [HttpClient,\r\n            IAuthenticationService,\r\n            PromiseUtils,\r\n            HttpUtils, String, Object])\r\n    ], UnauthorizedErrorInterceptor);\r\n    return UnauthorizedErrorInterceptor;\r\n}());\r\nexport { UnauthorizedErrorInterceptor };\r\n//# sourceMappingURL=unauthorized-error.interceptor.js.map","references":["/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/common@8.2.14_@angular+core@8.2.14+rxjs@6.5.4/node_modules/@angular/common/http.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/constants.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/dtos/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/interfaces/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/interceptors/i-http-error.interceptor.ts"],"map":"{\"version\":3,\"file\":\"unauthorized-error.interceptor.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/services/interceptors/errors/unauthorized-error.interceptor.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/services/interceptors/errors/unauthorized-error.interceptor.d.ts","writeByteOrderMark":false,"text":"/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { HttpClient, HttpErrorResponse, HttpEvent, HttpRequest } from '@angular/common/http';\r\nimport { TypedMap } from '../../../dtos';\r\nimport { IAuthenticationService, IEventService } from '../../../interfaces';\r\nimport { HttpUtils, PromiseUtils } from '../../../utils';\r\nimport { IHttpErrorInterceptor } from '../i-http-error.interceptor';\r\nexport declare const GET_REQUESTS_ON_HOLD_MAP: TypedMap<Promise<HttpEvent<any>>>;\r\n/**\r\n * @ngdoc service\r\n * @name @smartutils.services:unauthorizedErrorInterceptor\r\n * @description\r\n * Used for HTTP error code 401 (Forbidden). It will display the login modal.\r\n */\r\nexport declare class UnauthorizedErrorInterceptor<T = any> implements IHttpErrorInterceptor<T> {\r\n    private httpClient;\r\n    private authenticationService;\r\n    private promiseUtils;\r\n    private httpUtils;\r\n    private eventService;\r\n    private promisesToResolve;\r\n    private rejectedUrls;\r\n    constructor(httpClient: HttpClient, authenticationService: IAuthenticationService, promiseUtils: PromiseUtils, httpUtils: HttpUtils, WHO_AM_I_RESOURCE_URI: string, eventService: IEventService);\r\n    predicate(request: HttpRequest<T>, response: HttpErrorResponse): boolean;\r\n    responseError(request: HttpRequest<T>, response: HttpErrorResponse): Promise<any>;\r\n    private isUrlNotRejected;\r\n}\r\n"}}
