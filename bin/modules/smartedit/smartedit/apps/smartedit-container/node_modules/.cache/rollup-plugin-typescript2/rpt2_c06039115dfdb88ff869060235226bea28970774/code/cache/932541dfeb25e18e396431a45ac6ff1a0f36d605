{"code":"import { __decorate, __metadata, __param } from \"tslib\";\r\n/*\r\n * Copyright (c) 2021 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\nimport { Inject } from '@angular/core';\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { CrossFrameEventService, EVENT_STRICT_PREVIEW_MODE_REQUESTED, EVENTS, GatewayFactory, HEART_BEAT_TIMEOUT_THRESHOLD_MS_TOKEN, ISharedDataService, NG_ROUTE_PREFIX, SeDowngradeService, SmarteditRoutingService, STORE_FRONT_CONTEXT, WindowUtils } from 'smarteditcommons';\r\nimport { HeartBeatAlertComponent } from '../components/heartBeat/HeartBeatAlertComponent';\r\nimport { AlertFactory } from './alerts';\r\n/* @internal */\r\nvar /* @ngInject */ HeartBeatService = /** @class */ (function () {\r\n    function /* @ngInject */ HeartBeatService(HEART_BEAT_TIMEOUT_THRESHOLD_MS, translate, routingService, windowUtils, alertFactory, crossFrameEventService, gatewayFactory, sharedDataService) {\r\n        var _this = this;\r\n        this.HEART_BEAT_TIMEOUT_THRESHOLD_MS = HEART_BEAT_TIMEOUT_THRESHOLD_MS;\r\n        this.routingService = routingService;\r\n        this.windowUtils = windowUtils;\r\n        this.crossFrameEventService = crossFrameEventService;\r\n        this.sharedDataService = sharedDataService;\r\n        this.reconnectingInProgress = false;\r\n        /**\r\n         * @internal\r\n         * Hide all alerts and cancel all pending actions and timers.\r\n         */\r\n        this.resetAndStop = function () {\r\n            _this.reconnectingInProgress = false;\r\n            if (_this.cancellableTimeoutTimer) {\r\n                clearTimeout(_this.cancellableTimeoutTimer);\r\n                _this.cancellableTimeoutTimer = null;\r\n            }\r\n            _this.reconnectingAlert.hide();\r\n            _this.reconnectedAlert.hide();\r\n        };\r\n        /**\r\n         * Connection to iframe has been lost, show reconnected alert to user\r\n         */\r\n        this.connectionLost = function () {\r\n            _this.resetAndStop();\r\n            if (!!_this.windowUtils.getGatewayTargetFrame()) {\r\n                _this.reconnectingAlert.show();\r\n            }\r\n            _this.reconnectingInProgress = true;\r\n        };\r\n        this.reconnectingAlert = alertFactory.createInfo({\r\n            component: HeartBeatAlertComponent,\r\n            duration: -1,\r\n            dismissible: false\r\n        });\r\n        this.reconnectedAlert = alertFactory.createInfo({\r\n            message: translate.instant('se.heartbeat.reconnection'),\r\n            timeout: 3000\r\n        });\r\n        var heartBeatGateway = gatewayFactory.createGateway(/* @ngInject */ HeartBeatService_1.HEART_BEAT_GATEWAY_ID);\r\n        heartBeatGateway.subscribe(/* @ngInject */ HeartBeatService_1.HEART_BEAT_MSG_ID, function () {\r\n            return _this.heartBeatReceived();\r\n        });\r\n        this.crossFrameEventService.subscribe(EVENTS.PAGE_CHANGE, function () {\r\n            _this.resetAndStop();\r\n            // assume every page is smarteditable ¯\\_(ツ)_/¯\r\n            return _this.heartBeatReceived();\r\n        });\r\n        this.routingService.routeChangeSuccess().subscribe(function (event) {\r\n            var url = _this.routingService.getCurrentUrlFromEvent(event);\r\n            if (url === \"/\" + NG_ROUTE_PREFIX + STORE_FRONT_CONTEXT) {\r\n                return _this.heartBeatReceived();\r\n            }\r\n            return Promise.resolve();\r\n        });\r\n        this.routingService.routeChangeStart().subscribe(function () {\r\n            _this.resetAndStop();\r\n        });\r\n    }\r\n    /* @ngInject */ HeartBeatService_1 = /* @ngInject */ HeartBeatService;\r\n    /**\r\n     * @internal\r\n     * Heartbeat received from iframe, show reconnected if connection was previously\r\n     * lost, and restart the timer to wait for iframe heartbeat\r\n     */\r\n    /* @ngInject */ HeartBeatService.prototype.heartBeatReceived = function () {\r\n        var _this = this;\r\n        var reconnecting = this.reconnectingInProgress;\r\n        this.resetAndStop();\r\n        if (reconnecting) {\r\n            if (!!this.windowUtils.getGatewayTargetFrame()) {\r\n                this.reconnectedAlert.show();\r\n            }\r\n            this.reconnectingInProgress = false;\r\n            // Publish an event to enable the perspective selector in case if it is disabled\r\n            this.crossFrameEventService.publish(EVENT_STRICT_PREVIEW_MODE_REQUESTED, false);\r\n        }\r\n        return this.sharedDataService\r\n            .get('configuration')\r\n            .then(function (_a) {\r\n            var heartBeatTimeoutThreshold = _a.heartBeatTimeoutThreshold;\r\n            if (!heartBeatTimeoutThreshold) {\r\n                heartBeatTimeoutThreshold = _this.HEART_BEAT_TIMEOUT_THRESHOLD_MS;\r\n            }\r\n            _this.cancellableTimeoutTimer = _this.windowUtils.runTimeoutOutsideAngular(_this.connectionLost, +heartBeatTimeoutThreshold);\r\n        });\r\n    };\r\n    var /* @ngInject */ HeartBeatService_1;\r\n    /* @ngInject */ HeartBeatService.HEART_BEAT_GATEWAY_ID = 'heartBeatGateway';\r\n    /* @ngInject */ HeartBeatService.HEART_BEAT_MSG_ID = 'heartBeat';\r\n    /* @ngInject */ HeartBeatService = /* @ngInject */ HeartBeatService_1 = __decorate([\r\n        SeDowngradeService(),\r\n        __param(0, Inject(HEART_BEAT_TIMEOUT_THRESHOLD_MS_TOKEN)),\r\n        __metadata(\"design:paramtypes\", [Number, TranslateService,\r\n            SmarteditRoutingService,\r\n            WindowUtils,\r\n            AlertFactory,\r\n            CrossFrameEventService,\r\n            GatewayFactory,\r\n            ISharedDataService])\r\n    ], /* @ngInject */ HeartBeatService);\r\n    return /* @ngInject */ HeartBeatService;\r\n}());\r\nexport { /* @ngInject */ HeartBeatService };\r\n//# sourceMappingURL=HeartBeatService.js.map","references":["/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/router@8.2.14_e9fbe5720e9434eb9ae0f6720f1ca3f4/node_modules/@angular/router/router.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@ngx-translate/core@11.0.1_@angular+core@8.2.14+rxjs@6.5.4/node_modules/@ngx-translate/core/ngx-translate-core.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smartedit-commons/dist/index.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smartedit-container/src/components/heartBeat/HeartBeatAlertComponent.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smartedit-container/src/services/alerts/index.ts"],"map":"{\"version\":3,\"file\":\"HeartBeatService.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/services/HeartBeatService.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smartedit-container/services/HeartBeatService.d.ts","writeByteOrderMark":false,"text":"import { TranslateService } from '@ngx-translate/core';\r\nimport { CrossFrameEventService, GatewayFactory, ISharedDataService, SmarteditRoutingService, WindowUtils } from 'smarteditcommons';\r\nimport { AlertFactory } from './alerts';\r\nexport declare class HeartBeatService {\r\n    private HEART_BEAT_TIMEOUT_THRESHOLD_MS;\r\n    private routingService;\r\n    private windowUtils;\r\n    private crossFrameEventService;\r\n    private sharedDataService;\r\n    static readonly HEART_BEAT_GATEWAY_ID = \"heartBeatGateway\";\r\n    static readonly HEART_BEAT_MSG_ID = \"heartBeat\";\r\n    private reconnectingAlert;\r\n    private reconnectedAlert;\r\n    private reconnectingInProgress;\r\n    private cancellableTimeoutTimer;\r\n    constructor(HEART_BEAT_TIMEOUT_THRESHOLD_MS: number, translate: TranslateService, routingService: SmarteditRoutingService, windowUtils: WindowUtils, alertFactory: AlertFactory, crossFrameEventService: CrossFrameEventService, gatewayFactory: GatewayFactory, sharedDataService: ISharedDataService);\r\n    /**\r\n     * @internal\r\n     * Hide all alerts and cancel all pending actions and timers.\r\n     */\r\n    resetAndStop: () => void;\r\n    /**\r\n     * @internal\r\n     * Heartbeat received from iframe, show reconnected if connection was previously\r\n     * lost, and restart the timer to wait for iframe heartbeat\r\n     */\r\n    private heartBeatReceived;\r\n    /**\r\n     * Connection to iframe has been lost, show reconnected alert to user\r\n     */\r\n    private connectionLost;\r\n}\r\n"}}
