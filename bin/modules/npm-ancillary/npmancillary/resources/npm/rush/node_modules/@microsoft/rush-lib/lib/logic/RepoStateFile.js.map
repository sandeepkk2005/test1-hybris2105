{"version":3,"file":"RepoStateFile.js","sourceRoot":"","sources":["../../src/logic/RepoStateFile.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport { FileSystem, JsonFile, JsonSchema, NewlineKind } from '@rushstack/node-core-library';\r\n\r\nimport { RushConfiguration } from '../api/RushConfiguration';\r\nimport { PnpmShrinkwrapFile } from './pnpm/PnpmShrinkwrapFile';\r\nimport { CommonVersionsConfiguration } from '../api/CommonVersionsConfiguration';\r\n\r\n/**\r\n * This interface represents the raw repo-state.json file\r\n * Example:\r\n *  {\r\n *    \"pnpmShrinkwrapHash\": \"...\",\r\n *    \"preferredVersionsHash\": \"...\"\r\n *  }\r\n */\r\ninterface IRepoStateJson {\r\n  /**\r\n   * A hash of the PNPM shrinkwrap file contents\r\n   */\r\n  pnpmShrinkwrapHash?: string;\r\n  /**\r\n   * A hash of the CommonVersionsConfiguration.preferredVersions field\r\n   */\r\n  preferredVersionsHash?: string;\r\n}\r\n\r\n/**\r\n * This file is used to track the state of various Rush-related features. It is generated\r\n * and updated by Rush.\r\n *\r\n * @public\r\n */\r\nexport class RepoStateFile {\r\n  private static _jsonSchema: JsonSchema = JsonSchema.fromFile(\r\n    path.join(__dirname, '../schemas/repo-state.schema.json')\r\n  );\r\n\r\n  private _repoStateFilePath: string;\r\n  private _variant: string | undefined;\r\n  private _pnpmShrinkwrapHash: string | undefined;\r\n  private _preferredVersionsHash: string | undefined;\r\n  private _isValid: boolean;\r\n  private _modified: boolean = false;\r\n\r\n  private constructor(\r\n    repoStateJson: IRepoStateJson | undefined,\r\n    isValid: boolean,\r\n    filePath: string,\r\n    variant: string | undefined\r\n  ) {\r\n    this._repoStateFilePath = filePath;\r\n    this._variant = variant;\r\n    this._isValid = isValid;\r\n\r\n    if (repoStateJson) {\r\n      this._pnpmShrinkwrapHash = repoStateJson.pnpmShrinkwrapHash;\r\n      this._preferredVersionsHash = repoStateJson.preferredVersionsHash;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the absolute file path of the repo-state.json file.\r\n   */\r\n  public get filePath(): string {\r\n    return this._repoStateFilePath;\r\n  }\r\n\r\n  /**\r\n   * The hash of the pnpm shrinkwrap file at the end of the last update.\r\n   */\r\n  public get pnpmShrinkwrapHash(): string | undefined {\r\n    return this._pnpmShrinkwrapHash;\r\n  }\r\n\r\n  /**\r\n   * The hash of all preferred versions at the end of the last update.\r\n   */\r\n  public get preferredVersionsHash(): string | undefined {\r\n    return this._preferredVersionsHash;\r\n  }\r\n\r\n  /**\r\n   * If false, the repo-state.json file is not valid and its values cannot be relied upon\r\n   */\r\n  public get isValid(): boolean {\r\n    return this._isValid;\r\n  }\r\n\r\n  /**\r\n   * Loads the repo-state.json data from the specified file path.\r\n   * If the file has not been created yet, then an empty object is returned.\r\n   *\r\n   * @param jsonFilename - The path to the repo-state.json file.\r\n   * @param variant - The variant currently being used by Rush.\r\n   */\r\n  public static loadFromFile(jsonFilename: string, variant: string | undefined): RepoStateFile {\r\n    let fileContents: string | undefined;\r\n    try {\r\n      fileContents = FileSystem.readFile(jsonFilename);\r\n    } catch (error) {\r\n      if (!FileSystem.isNotExistError(error)) {\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    let foundMergeConflictMarker: boolean = false;\r\n    let repoStateJson: IRepoStateJson | undefined = undefined;\r\n    if (fileContents) {\r\n      try {\r\n        repoStateJson = JsonFile.parseString(fileContents);\r\n      } catch (error) {\r\n        // Look for a Git merge conflict marker. PNPM gracefully handles merge conflicts in pnpm-lock.yaml,\r\n        // so a user should be able to just run \"rush update\" if they get conflicts in pnpm-lock.yaml\r\n        // and repo-state.json and have Rush update both.\r\n        for (\r\n          let nextNewlineIndex: number = 0;\r\n          nextNewlineIndex > -1;\r\n          nextNewlineIndex = fileContents.indexOf('\\n', nextNewlineIndex + 1)\r\n        ) {\r\n          if (fileContents.substr(nextNewlineIndex + 1, 7) === '<<<<<<<') {\r\n            foundMergeConflictMarker = true;\r\n            repoStateJson = {\r\n              preferredVersionsHash: 'INVALID',\r\n              pnpmShrinkwrapHash: 'INVALID'\r\n            };\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (repoStateJson) {\r\n        this._jsonSchema.validateObject(repoStateJson, jsonFilename);\r\n      }\r\n    }\r\n\r\n    return new RepoStateFile(repoStateJson, !foundMergeConflictMarker, jsonFilename, variant);\r\n  }\r\n\r\n  /**\r\n   * Refresh the data contained in repo-state.json using the current state\r\n   * of the Rush repo, and save the file if changes were made.\r\n   *\r\n   * @param rushConfiguration - The Rush configuration for the repo.\r\n   *\r\n   * @returns true if the file was modified, otherwise false.\r\n   */\r\n  public refreshState(rushConfiguration: RushConfiguration): boolean {\r\n    // Only support saving the pnpm shrinkwrap hash if it was enabled\r\n    const preventShrinkwrapChanges: boolean =\r\n      rushConfiguration.packageManager === 'pnpm' &&\r\n      rushConfiguration.pnpmOptions &&\r\n      rushConfiguration.pnpmOptions.preventManualShrinkwrapChanges;\r\n    if (preventShrinkwrapChanges) {\r\n      const pnpmShrinkwrapFile: PnpmShrinkwrapFile | undefined = PnpmShrinkwrapFile.loadFromFile(\r\n        rushConfiguration.getCommittedShrinkwrapFilename(this._variant),\r\n        rushConfiguration.pnpmOptions\r\n      );\r\n\r\n      if (pnpmShrinkwrapFile) {\r\n        const shrinkwrapFileHash: string = pnpmShrinkwrapFile.getShrinkwrapHash(\r\n          rushConfiguration.experimentsConfiguration.configuration\r\n        );\r\n\r\n        if (this._pnpmShrinkwrapHash !== shrinkwrapFileHash) {\r\n          this._pnpmShrinkwrapHash = shrinkwrapFileHash;\r\n          this._modified = true;\r\n        }\r\n      }\r\n    } else if (this._pnpmShrinkwrapHash !== undefined) {\r\n      this._pnpmShrinkwrapHash = undefined;\r\n      this._modified = true;\r\n    }\r\n\r\n    // Currently, only support saving the preferred versions hash if using workspaces\r\n    const useWorkspaces: boolean =\r\n      rushConfiguration.pnpmOptions && rushConfiguration.pnpmOptions.useWorkspaces;\r\n    if (useWorkspaces) {\r\n      const commonVersions: CommonVersionsConfiguration = rushConfiguration.getCommonVersions(this._variant);\r\n      const preferredVersionsHash: string = commonVersions.getPreferredVersionsHash();\r\n      if (this._preferredVersionsHash !== preferredVersionsHash) {\r\n        this._preferredVersionsHash = preferredVersionsHash;\r\n        this._modified = true;\r\n      }\r\n    } else if (this._preferredVersionsHash !== undefined) {\r\n      this._preferredVersionsHash = undefined;\r\n      this._modified = true;\r\n    }\r\n\r\n    // Now that the file has been refreshed, we know its contents are valid\r\n    this._isValid = true;\r\n\r\n    return this._saveIfModified();\r\n  }\r\n\r\n  /**\r\n   * Writes the \"repo-state.json\" file to disk, using the filename that was passed to loadFromFile().\r\n   */\r\n  private _saveIfModified(): boolean {\r\n    if (this._modified) {\r\n      const content: string =\r\n        '// DO NOT MODIFY THIS FILE MANUALLY BUT DO COMMIT IT. It is generated and used by Rush.' +\r\n        `${NewlineKind.Lf}${this._serialize()}`;\r\n      FileSystem.writeFile(this._repoStateFilePath, content);\r\n      this._modified = false;\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  private _serialize(): string {\r\n    // We need to set these one-by-one, since JsonFile.stringify does not like undefined values\r\n    const repoStateJson: IRepoStateJson = {};\r\n    if (this._pnpmShrinkwrapHash) {\r\n      repoStateJson.pnpmShrinkwrapHash = this._pnpmShrinkwrapHash;\r\n    }\r\n    if (this._preferredVersionsHash) {\r\n      repoStateJson.preferredVersionsHash = this._preferredVersionsHash;\r\n    }\r\n\r\n    return JsonFile.stringify(repoStateJson, { newlineConversion: NewlineKind.Lf });\r\n  }\r\n}\r\n"]}