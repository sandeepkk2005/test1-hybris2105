{"code":"import { __decorate, __metadata, __param } from \"tslib\";\r\n/*\r\n * Copyright (c) 2021 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\nimport { Inject } from '@angular/core';\r\nimport * as lo from 'lodash';\r\nimport { functionsUtils, nodeUtils, CONTRACT_CHANGE_LISTENER_COMPONENT_PROCESS_STATUS, CONTRACT_CHANGE_LISTENER_PROCESS_EVENTS, ID_ATTRIBUTE, IPageInfoService, IPositionRegistry, IResizeListener, ISmartEditContractChangeListener, JQueryUtilsService, LogService, MUTATION_TYPES, PolyfillService, SeDowngradeService, SystemEventService, SMARTEDIT_COMPONENT_PROCESS_STATUS, TestModeService, TYPE_ATTRIBUTE, UUID_ATTRIBUTE, YJQUERY_TOKEN } from 'smarteditcommons';\r\nimport { ComponentHandlerService } from './ComponentHandlerService';\r\nvar COMPONENT_STATE;\r\n(function (COMPONENT_STATE) {\r\n    COMPONENT_STATE[\"ADDED\"] = \"added\";\r\n    COMPONENT_STATE[\"DESTROYED\"] = \"destroyed\";\r\n})(COMPONENT_STATE || (COMPONENT_STATE = {}));\r\n/*\r\n * interval at which manual listening/checks are executed\r\n * So far it is only by repositionListener\r\n * (resizeListener delegates to a self-contained third-party library and DOM mutations observation is done in native MutationObserver)\r\n */\r\n/* @internal */\r\nexport var DEFAULT_REPROCESS_TIMEOUT = 100;\r\n/* @internal */\r\nexport var DEFAULT_PROCESS_QUEUE_POLYFILL_INTERVAL = 250;\r\n/* @internal */\r\nexport var DEFAULT_CONTRACT_CHANGE_LISTENER_INTERSECTION_OBSERVER_OPTIONS = {\r\n    // The root to use for intersection.\r\n    // If not provided, use the top-level documentâ€™s viewport.\r\n    root: null,\r\n    // Same as margin, can be 1, 2, 3 or 4 components, possibly negative lengths.\r\n    // If an explicit root element is specified, components may be percentages of the\r\n    // root element size. If no explicit root element is specified, using a percentage\r\n    // is an error.\r\n    rootMargin: '1000px',\r\n    // Threshold(s) at which to trigger callback, specified as a ratio, or list of\r\n    // ratios, of (visible area / total area) of the observed element (hence all\r\n    // entries must be in the range [0, 1]). Callback will be invoked when the visible\r\n    // ratio of the observed element crosses a threshold in the list.\r\n    threshold: 0\r\n};\r\n/* @internal */\r\nexport var DEFAULT_CONTRACT_CHANGE_LISTENER_PROCESS_QUEUE_THROTTLE = 500;\r\n/* @internal */\r\nvar /* @ngInject */ SmartEditContractChangeListener = /** @class */ (function () {\r\n    function /* @ngInject */ SmartEditContractChangeListener(yjQueryUtilsService, componentHandlerService, pageInfoService, resizeListener, positionRegistry, logService, yjQuery, systemEventService, polyfillService, testModeService) {\r\n        var _this = this;\r\n        this.yjQueryUtilsService = yjQueryUtilsService;\r\n        this.componentHandlerService = componentHandlerService;\r\n        this.pageInfoService = pageInfoService;\r\n        this.resizeListener = resizeListener;\r\n        this.positionRegistry = positionRegistry;\r\n        this.logService = logService;\r\n        this.yjQuery = yjQuery;\r\n        this.systemEventService = systemEventService;\r\n        this.polyfillService = polyfillService;\r\n        this.testModeService = testModeService;\r\n        /*\r\n         * This is the configuration passed to the MutationObserver instance\r\n         */\r\n        this.MUTATION_OBSERVER_OPTIONS = {\r\n            /*\r\n             * enables observation of attribute mutations\r\n             */\r\n            attributes: true,\r\n            /*\r\n             * instruct the observer to keep in store the former values of the mutated attributes\r\n             */\r\n            attributeOldValue: true,\r\n            /*\r\n             * enables observation of addition and removal of nodes\r\n             */\r\n            childList: true,\r\n            characterData: false,\r\n            /*\r\n             * enables recursive lookup without which only addition and removal of DIRECT children of the observed DOM root would be collected\r\n             */\r\n            subtree: true\r\n        };\r\n        /*\r\n         * Component state values\r\n         * 'added' when _componentsAddedCallback was called\r\n         * 'destroyed' when _componentsRemovedCallback was called\r\n         */\r\n        this.enableExtendedView = false;\r\n        /*\r\n         * nullable callbacks provided to smartEditContractChangeListener for all the observed events\r\n         */\r\n        this._componentsAddedCallback = null;\r\n        this._componentsRemovedCallback = null;\r\n        this._componentResizedCallback = null;\r\n        this._componentRepositionedCallback = null;\r\n        this._onComponentChangedCallback = null;\r\n        this._pageChangedCallback = null;\r\n        this._throttledProcessQueue = lo.throttle(function () { return _this._rawProcessQueue(); }, DEFAULT_CONTRACT_CHANGE_LISTENER_PROCESS_QUEUE_THROTTLE);\r\n        /*\r\n         * Queue used to process components when intersecting the viewport\r\n         * {Array.<{isIntersecting: Boolean, parent: DOMElement, processed: SmartEditContractChangeListener.COMPONENT_STATE}>}\r\n         */\r\n        this.componentsQueue = new Map();\r\n        this.smartEditAttributeNames = [TYPE_ATTRIBUTE, ID_ATTRIBUTE, UUID_ATTRIBUTE];\r\n    }\r\n    /*\r\n     * wrapping for test purposes\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._newMutationObserver = function (callback) {\r\n        return new MutationObserver(callback);\r\n    };\r\n    /*\r\n     * wrapping for test purposes\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._newIntersectionObserver = function (callback) {\r\n        return new IntersectionObserver(callback, DEFAULT_CONTRACT_CHANGE_LISTENER_INTERSECTION_OBSERVER_OPTIONS);\r\n    };\r\n    /*\r\n     * Add the given entry to the componentsQueue\r\n     * The components in the queue are sorted according to their position in the DOM\r\n     * so that the adding of components is done to have parents before children\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._addToComponentQueue = function (entry) {\r\n        var component = this.componentsQueue.get(entry.target);\r\n        if (component) {\r\n            component.isIntersecting = entry.isIntersecting;\r\n        }\r\n        else if (this.yjQueryUtilsService.isInDOM(entry.target)) {\r\n            this.componentsQueue.set(entry.target, {\r\n                component: entry.target,\r\n                isIntersecting: entry.isIntersecting,\r\n                processed: null,\r\n                oldProcessedValue: null,\r\n                parent: this.componentHandlerService.getParent(entry.target)[0]\r\n            });\r\n        }\r\n    };\r\n    /*\r\n     * for e2e test purposes\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._componentsQueueLength = function () {\r\n        return this.componentsQueue.size;\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.isExtendedViewEnabled = function () {\r\n        return this.enableExtendedView;\r\n    };\r\n    /**\r\n     * Set the 'economyMode' to true for better performance.\r\n     * In economyMode, resize/position listeners are not present, and the current economyMode value is passed to the add /remove callbacks.\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.setEconomyMode = function (_mode) {\r\n        var _this = this;\r\n        this.economyMode = _mode;\r\n        if (!this.economyMode) {\r\n            // reactivate\r\n            Array.from(this.componentHandlerService.getFirstSmartEditComponentChildren(this.yjQuery('body'))).forEach(function (firstLevelComponent) {\r\n                _this.applyToSelfAndAllChildren(firstLevelComponent, function (node) {\r\n                    _this._registerSizeAndPositionListeners(node);\r\n                });\r\n            });\r\n        }\r\n    };\r\n    /*\r\n     * initializes and starts all Intersection/DOM listeners:\r\n     * - Intersection of smartEditComponents with the viewport\r\n     * - DOM mutations on smartEditComponents and page identifier (by Means of native MutationObserver)\r\n     * - smartEditComponents repositioning (by means of querying, with an interval, the list of repositioned components from the positionRegistry)\r\n     * - smartEditComponents resizing (by delegating to the injected resizeListener)\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.initListener = function () {\r\n        var _this = this;\r\n        this.enableExtendedView = this.polyfillService.isEligibleForExtendedView();\r\n        try {\r\n            this.pageInfoService.getPageUUID().then(function (pageUUID) {\r\n                _this.currentPage = pageUUID;\r\n                if (_this._pageChangedCallback) {\r\n                    _this.executeCallback(_this._pageChangedCallback.bind(undefined, _this.currentPage));\r\n                }\r\n            });\r\n        }\r\n        catch (e) {\r\n            // case when the page that has just loaded is an asynchronous one\r\n        }\r\n        this.systemEventService.subscribe(CONTRACT_CHANGE_LISTENER_PROCESS_EVENTS.RESTART_PROCESS, function () {\r\n            _this._processQueue();\r\n            return Promise.resolve();\r\n        });\r\n        // Intersection Observer not able to re-evaluate components that are not intersecting but going in and out of the extended viewport.\r\n        if (this.enableExtendedView) {\r\n            setInterval(function () {\r\n                _this._processQueue();\r\n            }, DEFAULT_PROCESS_QUEUE_POLYFILL_INTERVAL);\r\n        }\r\n        this.mutationObserver = this._newMutationObserver(this.mutationObserverCallback.bind(this));\r\n        this.mutationObserver.observe(document.body, this.MUTATION_OBSERVER_OPTIONS);\r\n        // Intersection Observer is used to observe intersection of components with the viewport.\r\n        // each time the 'isIntersecting' property of an entry (SmartEdit component) changes, the Intersection Callback is called.\r\n        // we are using the componentsQueue to hold the components references and their isIntersecting value.\r\n        this.intersectionObserver = this._newIntersectionObserver(function (entries) {\r\n            entries.forEach(function (entry) {\r\n                _this._addToComponentQueue(entry);\r\n            });\r\n            // A better approach would be to process each entry individually instead of processing the whole queue, but a bug Firefox v.55 prevent us to do so.\r\n            _this._processQueue();\r\n        });\r\n        // Observing all SmartEdit components that are already in the page.\r\n        // Note that when an element visible in the viewport is removed, the Intersection Callback is called so we don't need to use the Mutation Observe to observe the removal of Nodes.\r\n        Array.from(this.componentHandlerService.getFirstSmartEditComponentChildren(this.yjQuery('body'))).forEach(function (firstLevelComponent) {\r\n            _this.applyToSelfAndAllChildren(firstLevelComponent, _this.intersectionObserver.observe.bind(_this.intersectionObserver));\r\n        });\r\n        this._startExpendableListeners();\r\n    };\r\n    // Processing the queue with throttling in production to avoid scrolling lag when there is a lot of components in the page.\r\n    // No throttling when e2e mode is active\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._processQueue = function () {\r\n        if (this.testModeService.isE2EMode() || functionsUtils.isUnitTestMode()) {\r\n            this._rawProcessQueue();\r\n        }\r\n        else {\r\n            this._throttledProcessQueue();\r\n        }\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.isIntersecting = function (obj) {\r\n        if (!this.yjQueryUtilsService.isInDOM(obj.component)) {\r\n            return false;\r\n        }\r\n        return this.enableExtendedView\r\n            ? this.yjQueryUtilsService.isInExtendedViewPort(obj.component)\r\n            : obj.isIntersecting;\r\n    };\r\n    // for each component in the componentsQueue, we use the 'isIntersecting' and 'processed' values to add or remove it.\r\n    // An intersecting component that was not already added is added, and a non intersecting component that was added is removed (happens when scrolling, resizing the page, zooming, opening dev-tools)\r\n    // the 'PROCESS_COMPONENTS' promise is RESOLVED when the component can be added or removed, and it is REJECTED when the component can't be added but could be removed.\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._rawProcessQueue = function () {\r\n        var observedQueueArray = Array.from(this.componentsQueue.values());\r\n        this.systemEventService\r\n            .publish(CONTRACT_CHANGE_LISTENER_PROCESS_EVENTS.PROCESS_COMPONENTS, observedQueueArray.map(function (_a) {\r\n            var component = _a.component;\r\n            return component;\r\n        }))\r\n            .then(function (observedQueue, response) {\r\n            var _this = this;\r\n            var addedComponents = [];\r\n            var removedComponents = [];\r\n            var responseSet = new Set(response || []);\r\n            observedQueue.forEach(function (obj) {\r\n                if (!responseSet.has(obj.component)) {\r\n                    return;\r\n                }\r\n                var processStatus = obj.component.dataset[SMARTEDIT_COMPONENT_PROCESS_STATUS];\r\n                if (processStatus ===\r\n                    CONTRACT_CHANGE_LISTENER_COMPONENT_PROCESS_STATUS.PROCESS) {\r\n                    if (obj.processed !== COMPONENT_STATE.ADDED &&\r\n                        _this.isIntersecting(obj)) {\r\n                        addedComponents.push(obj);\r\n                    }\r\n                    else if (obj.processed === COMPONENT_STATE.ADDED &&\r\n                        !_this.isIntersecting(obj)) {\r\n                        removedComponents.push(obj);\r\n                    }\r\n                }\r\n                else if (processStatus ===\r\n                    CONTRACT_CHANGE_LISTENER_COMPONENT_PROCESS_STATUS.REMOVE) {\r\n                    if (obj.processed === COMPONENT_STATE.ADDED) {\r\n                        removedComponents.push(obj);\r\n                    }\r\n                }\r\n                obj.oldProcessedValue = obj.processed;\r\n            });\r\n            addedComponents.forEach(function (queueObj) {\r\n                queueObj.processed = COMPONENT_STATE.ADDED;\r\n            });\r\n            removedComponents.forEach(function (queueObj) {\r\n                queueObj.processed = COMPONENT_STATE.DESTROYED;\r\n            });\r\n            // If the intersection observer returns multiple time the same components in the callback (happen when doing a drag and drop or sfBuilder.actions.rerenderComponent)\r\n            // we will have these same components in BOTH addedComponents and removedComponents, hence we must first call _removeComponents and then _addComponents (in this order).\r\n            if (removedComponents.length) {\r\n                this._removeComponents(removedComponents);\r\n            }\r\n            if (addedComponents.length) {\r\n                addedComponents.sort(nodeUtils.compareHTMLElementsPosition('component'));\r\n                this._addComponents(addedComponents);\r\n            }\r\n            if (!this.economyMode) {\r\n                lo.chain(addedComponents.concat(removedComponents))\r\n                    .filter(function (obj) {\r\n                    return obj.oldProcessedValue === null ||\r\n                        !_this.yjQueryUtilsService.isInDOM(obj.component);\r\n                })\r\n                    .map('parent')\r\n                    .compact()\r\n                    .uniq()\r\n                    .value()\r\n                    .forEach(function (parent) {\r\n                    _this.repairParentResizeListener(parent);\r\n                });\r\n            }\r\n        }.bind(this, observedQueueArray));\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._addComponents = function (componentsObj) {\r\n        var _this = this;\r\n        if (this._componentsAddedCallback) {\r\n            this.executeCallback(this._componentsAddedCallback.bind(undefined, lo.map(componentsObj, 'component'), this.economyMode));\r\n        }\r\n        if (!this.economyMode) {\r\n            componentsObj\r\n                .filter(function (queueObj) { return queueObj.oldProcessedValue === null; })\r\n                .forEach(function (queueObj) {\r\n                _this._registerSizeAndPositionListeners(queueObj.component);\r\n            });\r\n        }\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._removeComponents = function (componentsObj, forceRemoval) {\r\n        var _this = this;\r\n        if (forceRemoval === void 0) { forceRemoval = false; }\r\n        componentsObj\r\n            .filter(function (queueObj) {\r\n            return !_this.yjQueryUtilsService.isInDOM(queueObj.component) || forceRemoval;\r\n        })\r\n            .forEach(function (queueObj) {\r\n            if (!_this.economyMode) {\r\n                _this._unregisterSizeAndPositionListeners(queueObj.component);\r\n            }\r\n            _this.componentsQueue.delete(queueObj.component);\r\n        });\r\n        if (this._componentsRemovedCallback) {\r\n            var removedComponents = componentsObj.map(function (obj) {\r\n                return lo.pick(obj, ['component', 'parent', 'oldAttributes']);\r\n            });\r\n            this.executeCallback(this._componentsRemovedCallback.bind(undefined, removedComponents, this.economyMode));\r\n        }\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._registerSizeAndPositionListeners = function (component) {\r\n        if (this._componentRepositionedCallback) {\r\n            this.positionRegistry.register(component);\r\n        }\r\n        if (this._componentResizedCallback) {\r\n            this.resizeListener.register(component, this._componentResizedCallback.bind(undefined, component));\r\n        }\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._unregisterSizeAndPositionListeners = function (component) {\r\n        if (this._componentRepositionedCallback) {\r\n            this.positionRegistry.unregister(component);\r\n        }\r\n        if (this._componentResizedCallback) {\r\n            this.resizeListener.unregister(component);\r\n        }\r\n    };\r\n    /*\r\n     * stops and clean up all listeners\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.stopListener = function () {\r\n        // Stop listening for DOM mutations\r\n        if (this.mutationObserver) {\r\n            this.mutationObserver.disconnect();\r\n        }\r\n        this.intersectionObserver.disconnect();\r\n        this.mutationObserver = null;\r\n        this._stopExpendableListeners();\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._stopExpendableListeners = function () {\r\n        // Stop listening for DOM resize\r\n        this.resizeListener.dispose();\r\n        // Stop listening for DOM repositioning\r\n        if (this.repositionListener) {\r\n            clearInterval(this.repositionListener);\r\n            this.repositionListener = null;\r\n        }\r\n        this.positionRegistry.dispose();\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype._startExpendableListeners = function () {\r\n        var _this = this;\r\n        if (this._componentRepositionedCallback) {\r\n            this.repositionListener = setInterval(function () {\r\n                _this.positionRegistry\r\n                    .getRepositionedComponents()\r\n                    .forEach(function (component) {\r\n                    _this._componentRepositionedCallback(component);\r\n                });\r\n            }, DEFAULT_REPROCESS_TIMEOUT);\r\n        }\r\n    };\r\n    /*\r\n     * registers a unique callback to be executed every time a smarteditComponent node is added to the DOM\r\n     * it is executed only once per subtree of smarteditComponent nodes being added\r\n     * the callback is invoked with the root node of a subtree\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.onComponentsAdded = function (callback) {\r\n        this._componentsAddedCallback = callback;\r\n    };\r\n    /*\r\n     * registers a unique callback to be executed every time a smarteditComponent node is removed from the DOM\r\n     * it is executed only once per subtree of smarteditComponent nodes being removed\r\n     * the callback is invoked with the root node of a subtree and its parent\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.onComponentsRemoved = function (callback) {\r\n        this._componentsRemovedCallback = callback;\r\n    };\r\n    /*\r\n     * registers a unique callback to be executed every time at least one of the smartEdit contract attributes of a smarteditComponent node is changed\r\n     * the callback is invoked with the mutated node itself and the map of old attributes\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.onComponentChanged = function (callback) {\r\n        this._onComponentChangedCallback = callback;\r\n    };\r\n    /*\r\n     * registers a unique callback to be executed every time a smarteditComponent node is resized in the DOM\r\n     * the callback is invoked with the resized node itself\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.onComponentResized = function (callback) {\r\n        this._componentResizedCallback = callback;\r\n    };\r\n    /*\r\n     * registers a unique callback to be executed every time a smarteditComponent node is repositioned (as per Node.getBoundingClientRect()) in the DOM\r\n     * the callback is invoked with the resized node itself\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.onComponentRepositioned = function (callback) {\r\n        this._componentRepositionedCallback = callback;\r\n    };\r\n    /*\r\n     * registers a unique callback to be executed:\r\n     * - upon bootstrapping smartEdit IF the page identifier is available\r\n     * - every time the page identifier is changed in the DOM (see pageInfoService.getPageUUID())\r\n     * the callback is invoked with the new page identifier read from pageInfoService.getPageUUID()\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.onPageChanged = function (callback) {\r\n        this._pageChangedCallback = callback;\r\n    };\r\n    /*\r\n     * Method used in mutationObserverCallback that extracts from mutations the list of nodes added\r\n     * The nodes are returned within a pair along with their nullable closest smartEditComponent parent\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.aggregateAddedOrRemovedNodesAndTheirParents = function (mutations, type) {\r\n        var _this = this;\r\n        var entries = mutations\r\n            .filter(function (mutation) {\r\n            // only keep mutations of type childList and [added/removed]Nodes\r\n            return mutation.type === MUTATION_TYPES.CHILD_LIST.NAME &&\r\n                mutation[type] &&\r\n                mutation[type].length;\r\n        })\r\n            .map(function (mutation) {\r\n            // the mutated child may not be smartEditComponent, in such case we return their first level smartEditComponent children\r\n            var children = lo\r\n                .flatten(Array.from(mutation[type])\r\n                .filter(function (node) { return node.nodeType === Node.ELEMENT_NODE; })\r\n                .map(function (child) {\r\n                return _this.componentHandlerService.isSmartEditComponent(child)\r\n                    ? child\r\n                    : Array.from(_this.componentHandlerService.getFirstSmartEditComponentChildren(child));\r\n            }))\r\n                .sort(nodeUtils.compareHTMLElementsPosition());\r\n            // nodes are returned in pairs with their nullable parent\r\n            var parent = _this.componentHandlerService.getClosestSmartEditComponent(mutation.target);\r\n            return children.map(function (node) { return ({\r\n                node: node,\r\n                parent: parent.length ? parent[0] : null\r\n            }); });\r\n        });\r\n        /*\r\n         * Despite MutationObserver specifications it so happens that sometimes,\r\n         * depending on the very way a parent node is added with its children,\r\n         * parent AND children will appear in a same mutation. We then must only keep the parent\r\n         * Since the parent will appear first, the filtering lodash.uniqWith will always return the parent as opposed to the child which is what we need\r\n         */\r\n        return lo.uniqWith(lo.flatten(entries), function (entry1, entry2) {\r\n            return entry1.node.contains(entry2.node) || entry2.node.contains(entry1.node);\r\n        });\r\n    };\r\n    /*\r\n     * Method used in mutationObserverCallback that extracts from mutations the list of nodes the attributes of which have changed\r\n     * The nodes are returned within a pair along with their map of changed attributes\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.aggregateMutationsOnChangedAttributes = function (mutations) {\r\n        var map = mutations.reduce(function (seed, mutation) {\r\n            if (!(mutation.target &&\r\n                mutation.target.nodeType === Node.ELEMENT_NODE &&\r\n                mutation.type === MUTATION_TYPES.ATTRIBUTES.NAME)) {\r\n                return seed;\r\n            }\r\n            var targetEntry = seed.get(mutation.target);\r\n            if (!targetEntry) {\r\n                targetEntry = {\r\n                    node: mutation.target,\r\n                    oldAttributes: {}\r\n                };\r\n                seed.set(mutation.target, targetEntry);\r\n            }\r\n            targetEntry.oldAttributes[mutation.attributeName] = mutation.oldValue;\r\n            return seed;\r\n        }, new Map());\r\n        return Array.from(map.values());\r\n    };\r\n    /**\r\n     * Verifies whether the entry is a smartedit complient element.\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.isSmarteditNode = function (entry) {\r\n        return (this.componentHandlerService.isSmartEditComponent(entry.node) &&\r\n            this.smartEditAttributeNames.some(function (attributeName) {\r\n                return entry.node.hasAttribute(attributeName);\r\n            }));\r\n    };\r\n    /**\r\n     * Verifies whether at least one of the changed attributes is a smartedit attribute.\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.isSmarteditAttributeChanged = function (entry) {\r\n        return this.smartEditAttributeNames.some(function (attributeName) {\r\n            return entry.oldAttributes.hasOwnProperty(attributeName);\r\n        });\r\n    };\r\n    /**\r\n     * Verifies whether the entry is not a smartedit element anymore.\r\n     * It checks that all smartedit related attributes were removed and the\r\n     * entry.node is still in the componentsQueue.\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.wasSmarteditNode = function (entry) {\r\n        return (this.componentsQueue.has(entry.node) &&\r\n            this.smartEditAttributeNames.every(function (attributeName) { return !entry.node.hasAttribute(attributeName); }));\r\n    };\r\n    /*\r\n     * Methods used in mutationObserverCallback that determines whether the smartEdit contract page identifier MAY have changed in the DOM\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.mutationsHasPageChange = function (mutations) {\r\n        return mutations.find(function (mutation) {\r\n            var element = mutation.target;\r\n            return (mutation.type === MUTATION_TYPES.ATTRIBUTES.NAME &&\r\n                element.tagName === 'BODY' &&\r\n                mutation.attributeName === 'class');\r\n        });\r\n    };\r\n    /*\r\n     * convenience method to invoke a callback on a node and recursively on all its smartEditComponent children\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.applyToSelfAndAllChildren = function (node, callback) {\r\n        var _this = this;\r\n        callback(node);\r\n        Array.from(this.componentHandlerService.getFirstSmartEditComponentChildren(node)).forEach(function (component) {\r\n            _this.applyToSelfAndAllChildren(component, callback);\r\n        });\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.repairParentResizeListener = function (parent) {\r\n        if (parent) {\r\n            // the adding of a component is likely to destroy the DOM added by the resizeListener on the parent, it needs be restored\r\n            /*\r\n             * since the DOM hierarchy is processed in order, by the time we need repair the parent,\r\n             * it has already been processed so we can rely on its process status to know whether it is eligible\r\n             */\r\n            var parentObj = this.componentsQueue.get(parent);\r\n            if (parentObj &&\r\n                parentObj.processed === COMPONENT_STATE.ADDED &&\r\n                this.yjQueryUtilsService.isInDOM(parent)) {\r\n                this._componentResizedCallback(parent);\r\n            }\r\n        }\r\n    };\r\n    /*\r\n     * when a callback is executed we make sure that angular is synchronized since it is occurring outside the life cycle\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.executeCallback = function (callback) {\r\n        if (this.testModeService.isE2EMode() || functionsUtils.isUnitTestMode()) {\r\n            callback();\r\n        }\r\n        else {\r\n            setTimeout(function () { return callback(); }, 0);\r\n        }\r\n    };\r\n    /*\r\n     * callback executed by the mutation observer every time mutations occur.\r\n     * repositioning and resizing are not part of this except that every time a smartEditComponent is added,\r\n     * it is registered within the positionRegistry and the resizeListener\r\n     */\r\n    /* @ngInject */ SmartEditContractChangeListener.prototype.mutationObserverCallback = function (mutations) {\r\n        var _this = this;\r\n        this.logService.debug(mutations);\r\n        if (this._pageChangedCallback && this.mutationsHasPageChange(mutations)) {\r\n            this.pageInfoService.getPageUUID().then(function (newPageUUID) {\r\n                if (_this.currentPage !== newPageUUID) {\r\n                    _this.executeCallback(_this._pageChangedCallback.bind(undefined, newPageUUID));\r\n                }\r\n                _this.currentPage = newPageUUID;\r\n            });\r\n        }\r\n        if (this._componentsAddedCallback) {\r\n            this.aggregateAddedOrRemovedNodesAndTheirParents(mutations, MUTATION_TYPES.CHILD_LIST.ADD_OPERATION).forEach(function (childAndParent) {\r\n                _this.applyToSelfAndAllChildren(childAndParent.node, _this.intersectionObserver.observe.bind(_this.intersectionObserver));\r\n            });\r\n        }\r\n        this.aggregateAddedOrRemovedNodesAndTheirParents(mutations, MUTATION_TYPES.CHILD_LIST.REMOVE_OPERATION).forEach(function (childAndParent) {\r\n            _this.applyToSelfAndAllChildren(childAndParent.node, function (node) {\r\n                var component = _this.componentsQueue.get(node);\r\n                if (component) {\r\n                    if (!_this.economyMode) {\r\n                        _this.repairParentResizeListener(childAndParent.parent);\r\n                    }\r\n                    _this._removeComponents([\r\n                        {\r\n                            isIntersecting: false,\r\n                            component: node,\r\n                            parent: childAndParent.parent\r\n                        }\r\n                    ]);\r\n                }\r\n            });\r\n        });\r\n        if (this._onComponentChangedCallback) {\r\n            // TODO: are we missing tests here?\r\n            this.aggregateMutationsOnChangedAttributes(mutations).forEach(function (entry) {\r\n                if (_this.isSmarteditAttributeChanged(entry)) {\r\n                    if (_this.isSmarteditNode(entry)) {\r\n                        var component = _this.componentsQueue.get(entry.node);\r\n                        if (!component) {\r\n                            // Newly created smartedit element should always be in the component queue. If the component was created from\r\n                            // a simple div tag by adding smartedit attributes we need first to add the component to the queue even if the current\r\n                            // operation is change. If the component is not added to the queue it won't be rendered cause during the change callback\r\n                            // it sometimes won't be able to find a parent overlay (if it is outside of the viewport).\r\n                            _this.applyToSelfAndAllChildren(entry.node, _this.intersectionObserver.observe.bind(_this.intersectionObserver));\r\n                        }\r\n                        else {\r\n                            // the onComponentChanged is called with the mutated smartEditComponent subtree and the map of old attributes\r\n                            _this.executeCallback(_this._onComponentChangedCallback.bind(undefined, entry.node, entry.oldAttributes));\r\n                        }\r\n                    }\r\n                    else if (_this.wasSmarteditNode(entry)) {\r\n                        _this.applyToSelfAndAllChildren(entry.node, _this.intersectionObserver.unobserve.bind(_this.intersectionObserver));\r\n                        var parents = _this.componentHandlerService.getClosestSmartEditComponent(entry.node);\r\n                        _this._removeComponents([\r\n                            {\r\n                                isIntersecting: false,\r\n                                component: entry.node,\r\n                                parent: parents.length ? parents[0] : null,\r\n                                oldAttributes: entry.oldAttributes\r\n                            }\r\n                        ], true);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    };\r\n    /* @ngInject */ SmartEditContractChangeListener = __decorate([\r\n        SeDowngradeService(ISmartEditContractChangeListener),\r\n        __param(6, Inject(YJQUERY_TOKEN)),\r\n        __metadata(\"design:paramtypes\", [JQueryUtilsService,\r\n            ComponentHandlerService,\r\n            IPageInfoService,\r\n            IResizeListener,\r\n            IPositionRegistry,\r\n            LogService, Function, SystemEventService,\r\n            PolyfillService,\r\n            TestModeService])\r\n    ], /* @ngInject */ SmartEditContractChangeListener);\r\n    return /* @ngInject */ SmartEditContractChangeListener;\r\n}());\r\nexport { /* @ngInject */ SmartEditContractChangeListener };\r\n//# sourceMappingURL=SmartEditContractChangeListener.js.map","references":["/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@types/lodash@4.14.159/node_modules/@types/lodash/ts3.1/index.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smartedit-commons/dist/index.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smartedit/src/services/ComponentHandlerService.ts"],"map":"{\"version\":3,\"file\":\"SmartEditContractChangeListener.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/services/SmartEditContractChangeListener.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smartedit/services/SmartEditContractChangeListener.d.ts","writeByteOrderMark":false,"text":"/// <reference types=\"angular\" />\r\n/// <reference types=\"jquery\" />\r\nimport { ComponentEntry, IPageInfoService, IPositionRegistry, IResizeListener, ISmartEditContractChangeListener, JQueryUtilsService, LogService, PolyfillService, RemoveComponentObject, SystemEventService, TestModeService, TypedMap } from 'smarteditcommons';\r\nimport { ComponentHandlerService } from './ComponentHandlerService';\r\nexport declare const DEFAULT_REPROCESS_TIMEOUT = 100;\r\nexport declare const DEFAULT_PROCESS_QUEUE_POLYFILL_INTERVAL = 250;\r\nexport declare const DEFAULT_CONTRACT_CHANGE_LISTENER_INTERSECTION_OBSERVER_OPTIONS: {\r\n    root: HTMLElement;\r\n    rootMargin: string;\r\n    threshold: number;\r\n};\r\nexport declare const DEFAULT_CONTRACT_CHANGE_LISTENER_PROCESS_QUEUE_THROTTLE = 500;\r\nexport declare class SmartEditContractChangeListener implements ISmartEditContractChangeListener {\r\n    private yjQueryUtilsService;\r\n    private componentHandlerService;\r\n    private pageInfoService;\r\n    private resizeListener;\r\n    private positionRegistry;\r\n    private logService;\r\n    private yjQuery;\r\n    private systemEventService;\r\n    private polyfillService;\r\n    private testModeService;\r\n    private smartEditAttributeNames;\r\n    private MUTATION_OBSERVER_OPTIONS;\r\n    private mutationObserver;\r\n    private intersectionObserver;\r\n    private repositionListener;\r\n    private currentPage;\r\n    private enableExtendedView;\r\n    private _componentsAddedCallback;\r\n    private _componentsRemovedCallback;\r\n    private _componentResizedCallback;\r\n    private _componentRepositionedCallback;\r\n    private _onComponentChangedCallback;\r\n    private _pageChangedCallback;\r\n    private _throttledProcessQueue;\r\n    private componentsQueue;\r\n    private economyMode;\r\n    constructor(yjQueryUtilsService: JQueryUtilsService, componentHandlerService: ComponentHandlerService, pageInfoService: IPageInfoService, resizeListener: IResizeListener, positionRegistry: IPositionRegistry, logService: LogService, yjQuery: JQueryStatic, systemEventService: SystemEventService, polyfillService: PolyfillService, testModeService: TestModeService);\r\n    _newMutationObserver(callback: MutationCallback): MutationObserver;\r\n    _newIntersectionObserver(callback: IntersectionObserverCallback): IntersectionObserver;\r\n    _addToComponentQueue(entry: IntersectionObserverEntry): void;\r\n    _componentsQueueLength(): number;\r\n    isExtendedViewEnabled(): boolean;\r\n    /**\r\n     * Set the 'economyMode' to true for better performance.\r\n     * In economyMode, resize/position listeners are not present, and the current economyMode value is passed to the add /remove callbacks.\r\n     */\r\n    setEconomyMode(_mode: boolean): void;\r\n    initListener(): void;\r\n    _processQueue(): void;\r\n    isIntersecting(obj: ComponentEntry): boolean;\r\n    _rawProcessQueue(): void;\r\n    _addComponents(componentsObj: ComponentEntry[]): void;\r\n    _removeComponents(componentsObj: RemoveComponentObject[], forceRemoval?: boolean): void;\r\n    _registerSizeAndPositionListeners(component: HTMLElement): void;\r\n    _unregisterSizeAndPositionListeners(component: HTMLElement): void;\r\n    stopListener(): void;\r\n    _stopExpendableListeners(): void;\r\n    _startExpendableListeners(): void;\r\n    onComponentsAdded(callback: (components: HTMLElement[], isEconomyMode: boolean) => void): void;\r\n    onComponentsRemoved(callback: (components: {\r\n        component: HTMLElement;\r\n        parent: HTMLElement;\r\n    }[], isEconomyMode: boolean) => void): void;\r\n    onComponentChanged(callback: (component: HTMLElement, oldAttributes: TypedMap<string>) => void): void;\r\n    onComponentResized(callback: (component: HTMLElement) => void): void;\r\n    onComponentRepositioned(callback: (component: HTMLElement) => void): void;\r\n    onPageChanged(callback: (pageUUID: string) => void): void;\r\n    private aggregateAddedOrRemovedNodesAndTheirParents;\r\n    private aggregateMutationsOnChangedAttributes;\r\n    /**\r\n     * Verifies whether the entry is a smartedit complient element.\r\n     */\r\n    private isSmarteditNode;\r\n    /**\r\n     * Verifies whether at least one of the changed attributes is a smartedit attribute.\r\n     */\r\n    private isSmarteditAttributeChanged;\r\n    /**\r\n     * Verifies whether the entry is not a smartedit element anymore.\r\n     * It checks that all smartedit related attributes were removed and the\r\n     * entry.node is still in the componentsQueue.\r\n     */\r\n    private wasSmarteditNode;\r\n    private mutationsHasPageChange;\r\n    private applyToSelfAndAllChildren;\r\n    private repairParentResizeListener;\r\n    private executeCallback;\r\n    private mutationObserverCallback;\r\n}\r\n"}}
