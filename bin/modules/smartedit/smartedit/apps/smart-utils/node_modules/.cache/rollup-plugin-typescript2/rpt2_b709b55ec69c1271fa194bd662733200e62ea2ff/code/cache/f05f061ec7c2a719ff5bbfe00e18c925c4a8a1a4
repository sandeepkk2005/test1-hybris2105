{"code":"import { __decorate, __metadata } from \"tslib\";\r\n/*\r\n * Copyright (c) 2021 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { Injectable } from '@angular/core';\r\nimport { PromiseUtils, WindowUtils } from '../../../utils';\r\nimport { LogService } from '../../log.service';\r\n/** @internal */\r\nvar CacheEngine = /** @class */ (function () {\r\n    function CacheEngine(windowUtils, promiseUtils, logService) {\r\n        this.windowUtils = windowUtils;\r\n        this.promiseUtils = promiseUtils;\r\n        this.logService = logService;\r\n        this.cachedItemsRegistry = [];\r\n        this.startBackgroundMonitoringJob();\r\n    }\r\n    CacheEngine_1 = CacheEngine;\r\n    CacheEngine.prototype.addItem = function (item, cacheTiming, refresh) {\r\n        if (this.getItemIndex(item) === -1) {\r\n            this.cachedItemsRegistry.push({\r\n                item: item,\r\n                cacheTiming: cacheTiming,\r\n                refresh: refresh,\r\n                completed: false,\r\n                processing: false,\r\n                defer: this.promiseUtils.defer()\r\n            });\r\n        }\r\n        else {\r\n            this.logService.warn(\"CacheEngine - item already exist for id: \" + item.id);\r\n        }\r\n    };\r\n    CacheEngine.prototype.getItemById = function (id) {\r\n        var match = this.cachedItemsRegistry.find(function (obj) { return obj.item.id === id; });\r\n        return match ? match.item : null;\r\n    };\r\n    CacheEngine.prototype.handle = function (item) {\r\n        var obj = this.cachedItemsRegistry[this.getItemIndex(item)];\r\n        if (obj.completed && !this.hasExpired(item)) {\r\n            obj.defer.resolve(item.cache);\r\n        }\r\n        else if (!obj.processing) {\r\n            obj.processing = true;\r\n            this.refreshCache(obj);\r\n        }\r\n        return obj.defer.promise;\r\n    };\r\n    CacheEngine.prototype.evict = function () {\r\n        var _this = this;\r\n        var tags = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            tags[_i] = arguments[_i];\r\n        }\r\n        tags.forEach(function (tag) {\r\n            _this.cachedItemsRegistry\r\n                .filter(function (obj) { return obj.item.evictionTags.indexOf(tag) > -1; })\r\n                .forEach(function (obj) { return _this.cachedItemsRegistry.splice(_this.getItemIndex(obj.item), 1); });\r\n        });\r\n    };\r\n    // regularly go though cache data and call prebound methods to refresh data when needed.\r\n    CacheEngine.prototype.startBackgroundMonitoringJob = function () {\r\n        var _this = this;\r\n        this.windowUtils.runIntervalOutsideAngular(function () {\r\n            return Promise.all(_this.cachedItemsRegistry\r\n                .filter(function (obj) { return _this.needRefresh(obj.item); })\r\n                .map(function (obj) { return _this.refreshCache(obj); }));\r\n        }, CacheEngine_1.BACKGROUND_REFRESH_INTERVAL);\r\n    };\r\n    CacheEngine.prototype.refreshCache = function (obj) {\r\n        var _this = this;\r\n        return obj.refresh().then(function (value) {\r\n            // TODO: read value.metadata to refresh expiry/refresh ages.\r\n            obj.cacheTiming.setAge(obj.item);\r\n            obj.item.cache = value;\r\n            obj.item.timestamp = new Date().getTime();\r\n            obj.completed = true;\r\n            obj.processing = false;\r\n            obj.defer.resolve(value);\r\n        }, function (e) {\r\n            _this.logService.debug(\"CacheEngine - unable to refresh cache for id: \" + obj.item.id, e);\r\n            delete obj.item.cache;\r\n            obj.defer.reject(e);\r\n        });\r\n    };\r\n    CacheEngine.prototype.hasExpired = function (item) {\r\n        return item.timestamp + item.expirationAge <= new Date().getTime();\r\n    };\r\n    CacheEngine.prototype.needRefresh = function (item) {\r\n        return item.timestamp + item.refreshAge <= new Date().getTime();\r\n    };\r\n    CacheEngine.prototype.getItemIndex = function (item) {\r\n        return this.cachedItemsRegistry.findIndex(function (o) { return o.item.id === item.id; });\r\n    };\r\n    var CacheEngine_1;\r\n    CacheEngine.BACKGROUND_REFRESH_INTERVAL = 10000;\r\n    CacheEngine = CacheEngine_1 = __decorate([\r\n        Injectable(),\r\n        __metadata(\"design:paramtypes\", [WindowUtils,\r\n            PromiseUtils,\r\n            LogService])\r\n    ], CacheEngine);\r\n    return CacheEngine;\r\n}());\r\nexport { CacheEngine };\r\n//# sourceMappingURL=cache-engine.js.map","references":["/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/log.service.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/cache/engine/interfaces/index.ts"],"map":"{\"version\":3,\"file\":\"cache-engine.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/services/cache/engine/cache-engine.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/services/cache/engine/cache-engine.d.ts","writeByteOrderMark":false,"text":"import { Deferred, PromiseUtils, WindowUtils } from '../../../utils';\r\nimport { LogService } from '../../log.service';\r\nimport { ICacheItem, ICacheTiming } from './interfaces';\r\n/** @internal */\r\nexport interface ICacheItemRegistry {\r\n    item: ICacheItem<any>;\r\n    cacheTiming: ICacheTiming;\r\n    completed: boolean;\r\n    processing: boolean;\r\n    defer: Deferred<any>;\r\n    refresh<T>(): Promise<T>;\r\n}\r\n/** @internal */\r\nexport declare class CacheEngine {\r\n    private windowUtils;\r\n    private promiseUtils;\r\n    private logService;\r\n    static readonly BACKGROUND_REFRESH_INTERVAL: number;\r\n    private cachedItemsRegistry;\r\n    constructor(windowUtils: WindowUtils, promiseUtils: PromiseUtils, logService: LogService);\r\n    addItem(item: ICacheItem<any>, cacheTiming: ICacheTiming, refresh: <T>() => Promise<T>): void;\r\n    getItemById(id: string): ICacheItem<any> | null;\r\n    handle<T>(item: ICacheItem<any>): Promise<T>;\r\n    evict(...tags: string[]): void;\r\n    protected startBackgroundMonitoringJob(): void;\r\n    protected refreshCache<T>(obj: ICacheItemRegistry): Promise<T | void>;\r\n    private hasExpired;\r\n    private needRefresh;\r\n    private getItemIndex;\r\n}\r\n"}}
