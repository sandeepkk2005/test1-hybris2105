{"code":"import { __decorate, __metadata } from \"tslib\";\r\n/*\r\n * Copyright (c) 2021 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Injectable, Injector } from '@angular/core';\r\nimport { PromiseUtils, WindowUtils } from '../../utils';\r\nvar SSO_DIALOG_MARKER = 'sso';\r\nvar SSO_PROPERTIES;\r\n(function (SSO_PROPERTIES) {\r\n    SSO_PROPERTIES[\"SSO_CLIENT_ID\"] = \"SSO_CLIENT_ID\";\r\n    SSO_PROPERTIES[\"SSO_AUTHENTICATION_ENTRY_POINT\"] = \"SSO_AUTHENTICATION_ENTRY_POINT\";\r\n    SSO_PROPERTIES[\"SSO_LOGOUT_ENTRY_POINT\"] = \"SSO_LOGOUT_ENTRY_POINT\";\r\n    SSO_PROPERTIES[\"SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT\"] = \"SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT\";\r\n})(SSO_PROPERTIES || (SSO_PROPERTIES = {}));\r\nvar CHILD_SMARTEDIT_SENDING_AUTHTOKEN = 'ssoAuthenticate';\r\nvar CHILD_SMARTEDIT_SENDING_AUTH_ERROR = 'ssoAuthenticateError';\r\nvar SSODIALOG_WINDOW = 'SSODIALOG_WINDOW';\r\n/*\r\n * Helper to initiate a SAML /SSO autentication sequence through a pop-up\r\n * (because the sequence involves auto-submiting html form at some point that causes a redirect and hence would\r\n * loose app context if not executed in a different window)\r\n * that ultimately loads the app again which in turn will detect its context and do the following:\r\n * - will not continue loading\r\n * - wil post the loginToken to the /authenticate end point to retrieve oAuth access\r\n * - will send back to parent (through postMessage) the retrieved oAuth access\r\n * - will close;\r\n */\r\nvar SSOAuthenticationHelper = /** @class */ (function () {\r\n    function SSOAuthenticationHelper(windowUtils, promiseUtils, httpClient, injector) {\r\n        this.windowUtils = windowUtils;\r\n        this.promiseUtils = promiseUtils;\r\n        this.httpClient = httpClient;\r\n        this.injector = injector;\r\n        this.logoutIframeId = 'logoutIframe';\r\n        this.deferred = null;\r\n        this.listenForAuthTokenBeingSentBack();\r\n    }\r\n    SSOAuthenticationHelper_1 = SSOAuthenticationHelper;\r\n    /*\r\n     * Initiates the SSO dialog through a pop-up\r\n     */\r\n    SSOAuthenticationHelper.prototype.launchSSODialog = function () {\r\n        this.deferred = this.promiseUtils.defer();\r\n        var ssoAuthenticationEntryPoint = this.injector.get(SSO_PROPERTIES.SSO_AUTHENTICATION_ENTRY_POINT) +\r\n            this.getSSOContextPath();\r\n        this.window.open(ssoAuthenticationEntryPoint, SSODIALOG_WINDOW, 'toolbar=no,scrollbars=no,resizable=no,top=200,left=200,width=1000,height=800');\r\n        return this.deferred.promise;\r\n    };\r\n    /*\r\n     * SSO happen in a popup window launched by AuthenticationHelper#launchSSODialog().\r\n     * Once SSO is successful, a 'LoginToken' cookie is present, this is a pre-requisite for doing a POST to the /authenticate\r\n     * endpoint that will return the Authorization bearer token.\r\n     * This bearer is then sent with postMessage to the opener window, i.e. the SmartEdit application that will resume the pending 401 request.\r\n     */\r\n    SSOAuthenticationHelper.prototype.completeDialog = function () {\r\n        var _this = this;\r\n        return new Promise(function (resolve, reject) {\r\n            _this.httpClient\r\n                .post(_this.injector.get(SSO_PROPERTIES.SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT), { client_id: _this.injector.get(SSO_PROPERTIES.SSO_CLIENT_ID) })\r\n                .subscribe(function (authToken) {\r\n                _this.window.opener.postMessage({\r\n                    eventId: CHILD_SMARTEDIT_SENDING_AUTHTOKEN,\r\n                    authToken: authToken\r\n                }, _this.document.location.origin);\r\n                _this.window.close();\r\n                resolve();\r\n            }, function (httpErrorResponse) {\r\n                var clonableHttpErrorResponse = {\r\n                    error: httpErrorResponse.error,\r\n                    status: httpErrorResponse.status\r\n                };\r\n                _this.window.opener.postMessage({\r\n                    eventId: CHILD_SMARTEDIT_SENDING_AUTH_ERROR,\r\n                    error: clonableHttpErrorResponse\r\n                }, _this.document.location.origin);\r\n                _this.window.close();\r\n                reject();\r\n            });\r\n        });\r\n    };\r\n    /*\r\n     * case of the App being a popup only meant for authentication and spun up buy the main app\r\n     */\r\n    SSOAuthenticationHelper.prototype.isSSODialog = function () {\r\n        return (this.window.name === SSODIALOG_WINDOW &&\r\n            new RegExp(\"[?&]\" + SSO_DIALOG_MARKER).test(location.search));\r\n    };\r\n    /*\r\n     * case of:\r\n     * - the App called from another app in an SSO context and that should therefore auto-authenticate with SSO\r\n     * - last manual authentication was with SSO\r\n     */\r\n    SSOAuthenticationHelper.prototype.isAutoSSOMain = function () {\r\n        return (SSOAuthenticationHelper_1.lastAuthenticatedWithSSO ||\r\n            (this.window.name !== SSODIALOG_WINDOW &&\r\n                new RegExp(\"[?&]\" + SSO_DIALOG_MARKER).test(location.search)));\r\n    };\r\n    SSOAuthenticationHelper.prototype.logout = function () {\r\n        var logoutIframe = this.logoutIframe;\r\n        if (!logoutIframe) {\r\n            logoutIframe = this.document.createElement('iframe');\r\n            logoutIframe.id = this.logoutIframeId;\r\n            logoutIframe.style.display = 'none';\r\n            this.document.body.appendChild(logoutIframe);\r\n        }\r\n        logoutIframe.src = this.injector.get(SSO_PROPERTIES.SSO_LOGOUT_ENTRY_POINT);\r\n        SSOAuthenticationHelper_1.lastAuthenticatedWithSSO = false;\r\n        this.document.location.href = this.document.location.href.replace(this.getSSOContextPath(), this.document.location.pathname);\r\n    };\r\n    // context path of app in an SSO mode\r\n    SSOAuthenticationHelper.prototype.getSSOContextPath = function () {\r\n        return this.document.location.pathname + \"?\" + SSO_DIALOG_MARKER;\r\n    };\r\n    SSOAuthenticationHelper.prototype.listenForAuthTokenBeingSentBack = function () {\r\n        var _this = this;\r\n        this.window.addEventListener('message', function (event) {\r\n            if (event.origin !== document.location.origin) {\r\n                return;\r\n            }\r\n            _this.logoutIframe && _this.logoutIframe.remove();\r\n            if (event.data.eventId === CHILD_SMARTEDIT_SENDING_AUTHTOKEN) {\r\n                SSOAuthenticationHelper_1.lastAuthenticatedWithSSO = true;\r\n                _this.deferred && _this.deferred.resolve(event.data.authToken);\r\n            }\r\n            else if (event.data.eventId === CHILD_SMARTEDIT_SENDING_AUTH_ERROR) {\r\n                _this.deferred && _this.deferred.reject(event.data.error);\r\n            }\r\n        }, false);\r\n    };\r\n    Object.defineProperty(SSOAuthenticationHelper.prototype, \"window\", {\r\n        get: function () {\r\n            return this.windowUtils.getWindow();\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(SSOAuthenticationHelper.prototype, \"document\", {\r\n        get: function () {\r\n            return this.window.document;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(SSOAuthenticationHelper.prototype, \"logoutIframe\", {\r\n        get: function () {\r\n            return this.document.querySelector(\"iframe#\" + this.logoutIframeId);\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    var SSOAuthenticationHelper_1;\r\n    // static in order to be shared by multiple instances\r\n    SSOAuthenticationHelper.lastAuthenticatedWithSSO = false;\r\n    SSOAuthenticationHelper = SSOAuthenticationHelper_1 = __decorate([\r\n        Injectable(),\r\n        __metadata(\"design:paramtypes\", [WindowUtils,\r\n            PromiseUtils,\r\n            HttpClient,\r\n            Injector])\r\n    ], SSOAuthenticationHelper);\r\n    return SSOAuthenticationHelper;\r\n}());\r\nexport { SSOAuthenticationHelper };\r\n//# sourceMappingURL=sso-authentication.helper.js.map","references":["/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/common@8.2.14_@angular+core@8.2.14+rxjs@6.5.4/node_modules/@angular/common/http.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/interfaces/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts"],"map":"{\"version\":3,\"file\":\"sso-authentication.helper.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../src/services/authentication/sso-authentication.helper.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/services/authentication/sso-authentication.helper.d.ts","writeByteOrderMark":false,"text":"/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Injector } from '@angular/core';\r\nimport { IAuthToken } from '../../interfaces';\r\nimport { PromiseUtils, WindowUtils } from '../../utils';\r\nexport declare class SSOAuthenticationHelper {\r\n    private windowUtils;\r\n    private promiseUtils;\r\n    private httpClient;\r\n    private injector;\r\n    private static lastAuthenticatedWithSSO;\r\n    private readonly logoutIframeId;\r\n    private deferred;\r\n    constructor(windowUtils: WindowUtils, promiseUtils: PromiseUtils, httpClient: HttpClient, injector: Injector);\r\n    launchSSODialog(): Promise<IAuthToken>;\r\n    completeDialog(): Promise<void>;\r\n    isSSODialog(): boolean;\r\n    isAutoSSOMain(): boolean;\r\n    logout(): any;\r\n    private getSSOContextPath;\r\n    private listenForAuthTokenBeingSentBack;\r\n    private get window();\r\n    private get document();\r\n    private get logoutIframe();\r\n}\r\n"}}
