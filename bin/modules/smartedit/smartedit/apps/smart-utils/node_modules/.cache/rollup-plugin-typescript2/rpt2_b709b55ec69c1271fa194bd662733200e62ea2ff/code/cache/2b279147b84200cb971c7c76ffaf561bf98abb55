{"code":"/*\r\n * Copyright (c) 2021 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\n/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\n/*\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n */\r\nimport { __assign, __decorate, __extends, __metadata, __param } from \"tslib\";\r\nimport { Inject, Optional } from '@angular/core';\r\nimport * as lodash from 'lodash';\r\nimport { LoginDialogComponent } from '../../components/login-dialog';\r\nimport { DEFAULT_AUTH_MAP, DEFAULT_AUTHENTICATION_ENTRY_POINT, DEFAULT_CREDENTIALS_MAP, EVENT_SERVICE, EVENTS } from '../../constants';\r\nimport { IAuthenticationManagerService, IAuthenticationService, IModalService, ISettingsService, ISharedDataService, IStorageService } from '../../interfaces';\r\nimport { functionsUtils } from '../../utils';\r\nimport { ITranslationsFetchService } from '../translations';\r\nimport { SSOAuthenticationHelper } from './sso-authentication.helper';\r\nvar AuthenticationService = /** @class */ (function (_super) {\r\n    __extends(AuthenticationService, _super);\r\n    function AuthenticationService(translationsFetchService, modalService, sharedDataService, storageService, eventService, ssoAuthenticationHelper, settingsService, authenticationManager) {\r\n        var _this = _super.call(this) || this;\r\n        _this.translationsFetchService = translationsFetchService;\r\n        _this.modalService = modalService;\r\n        _this.sharedDataService = sharedDataService;\r\n        _this.storageService = storageService;\r\n        _this.eventService = eventService;\r\n        _this.ssoAuthenticationHelper = ssoAuthenticationHelper;\r\n        _this.settingsService = settingsService;\r\n        _this.authenticationManager = authenticationManager;\r\n        return _this;\r\n    }\r\n    AuthenticationService.prototype.filterEntryPoints = function (resource) {\r\n        return this.sharedDataService.get('authenticationMap').then(function (authenticationMap) {\r\n            return functionsUtils\r\n                .convertToArray(__assign(__assign({}, (authenticationMap || {})), DEFAULT_AUTH_MAP))\r\n                .filter(function (entry) {\r\n                return new RegExp(entry.key, 'g').test(resource);\r\n            })\r\n                .map(function (element) { return element.value; });\r\n        });\r\n    };\r\n    AuthenticationService.prototype.isAuthEntryPoint = function (resource) {\r\n        return this.sharedDataService.get('authenticationMap').then(function (authenticationMap) {\r\n            var authEntryPoints = functionsUtils\r\n                .convertToArray(authenticationMap || {})\r\n                .map(function (element) { return element.value; });\r\n            return (authEntryPoints.indexOf(resource) > -1 ||\r\n                resource === DEFAULT_AUTHENTICATION_ENTRY_POINT);\r\n        });\r\n    };\r\n    AuthenticationService.prototype.authenticate = function (resource) {\r\n        var _this = this;\r\n        return this._findLoginData(resource).then(function (loginData) {\r\n            return _this._launchAuth(loginData).then(function (modalFeedback) {\r\n                Promise.resolve(_this.eventService.publish(EVENTS.AUTHORIZATION_SUCCESS, {\r\n                    userHasChanged: modalFeedback.userHasChanged\r\n                })).then(function () {\r\n                    if (modalFeedback.userHasChanged) {\r\n                        _this.eventService.publish(EVENTS.USER_HAS_CHANGED);\r\n                    }\r\n                    /**\r\n                     * We only need to reload when the user has changed and all authentication forms were closed.\r\n                     * There can be many authentication forms if some modules use different (from default one) end points.\r\n                     */\r\n                    var reauthInProcess = lodash\r\n                        .values(_this.reauthInProgress)\r\n                        .some(function (inProcess) { return inProcess; });\r\n                    if (modalFeedback.userHasChanged &&\r\n                        !reauthInProcess &&\r\n                        _this.authenticationManager &&\r\n                        _this.authenticationManager.onUserHasChanged) {\r\n                        _this.authenticationManager.onUserHasChanged();\r\n                    }\r\n                });\r\n                _this.reauthInProgress[loginData.authURI] = false;\r\n            });\r\n        });\r\n    };\r\n    AuthenticationService.prototype.logout = function () {\r\n        var _this = this;\r\n        // First, indicate the services that SmartEdit is logging out. This should give them the opportunity to clean up.\r\n        // NOTE: This is not synchronous since some clean-up might be lengthy, and logging out should be fast.\r\n        return this.eventService.publish(EVENTS.LOGOUT).then(function () {\r\n            _this.storageService.removeAllAuthTokens();\r\n            if (_this.ssoAuthenticationHelper.isAutoSSOMain()) {\r\n                _this.ssoAuthenticationHelper.logout();\r\n            }\r\n            else if (_this.authenticationManager && _this.authenticationManager.onLogout) {\r\n                _this.authenticationManager.onLogout();\r\n            }\r\n        });\r\n    };\r\n    AuthenticationService.prototype.isReAuthInProgress = function (entryPoint) {\r\n        return Promise.resolve(this.reauthInProgress[entryPoint] === true);\r\n    };\r\n    AuthenticationService.prototype.setReAuthInProgress = function (entryPoint) {\r\n        this.reauthInProgress[entryPoint] = true;\r\n        return Promise.resolve();\r\n    };\r\n    AuthenticationService.prototype.isAuthenticated = function (url) {\r\n        var _this = this;\r\n        return this.filterEntryPoints(url).then(function (entryPoints) {\r\n            var authURI = entryPoints && entryPoints[0];\r\n            return Promise.resolve(_this.storageService.getAuthToken(authURI)).then(function (authToken) { return !!authToken; });\r\n        });\r\n    };\r\n    /*\r\n     * will try determine first relevant authentication entry point from authenticationMap and retrieve potential client credentials to be added on top of user credentials\r\n     */\r\n    AuthenticationService.prototype._findLoginData = function (resource) {\r\n        var _this = this;\r\n        return this.filterEntryPoints(resource).then(function (entryPoints) {\r\n            return Promise.resolve(_this.sharedDataService.get('credentialsMap').then(function (credentialsMap) {\r\n                var map = __assign(__assign({}, (credentialsMap || {})), DEFAULT_CREDENTIALS_MAP);\r\n                var authURI = entryPoints[0];\r\n                return {\r\n                    authURI: authURI,\r\n                    clientCredentials: map[authURI]\r\n                };\r\n            }));\r\n        });\r\n    };\r\n    AuthenticationService.prototype._launchAuth = function (loginData) {\r\n        var _this = this;\r\n        return this.translationsFetchService\r\n            .waitToBeReady()\r\n            .then(function () {\r\n            return Promise.all([\r\n                _this.storageService.isInitialized(),\r\n                _this.settingsService.getBoolean('smartedit.sso.enabled')\r\n            ]);\r\n        })\r\n            .then(function (_a) {\r\n            var isFullScreen = _a[0], ssoEnabled = _a[1];\r\n            var modalRef = _this.modalService.open({\r\n                component: LoginDialogComponent,\r\n                data: __assign(__assign({}, loginData), { isFullScreen: isFullScreen,\r\n                    ssoEnabled: ssoEnabled }),\r\n                config: {\r\n                    modalPanelClass: 'su-login-dialog-container',\r\n                    hasBackdrop: false\r\n                }\r\n            });\r\n            _this.reauthInProgress = {};\r\n            return new Promise(function (resolve, reject) {\r\n                modalRef.afterClosed.subscribe(resolve, reject);\r\n            });\r\n        });\r\n    };\r\n    AuthenticationService = __decorate([\r\n        __param(4, Inject(EVENT_SERVICE)),\r\n        __param(7, Optional()),\r\n        __metadata(\"design:paramtypes\", [ITranslationsFetchService,\r\n            IModalService,\r\n            ISharedDataService,\r\n            IStorageService, Object, SSOAuthenticationHelper,\r\n            ISettingsService,\r\n            IAuthenticationManagerService])\r\n    ], AuthenticationService);\r\n    return AuthenticationService;\r\n}(IAuthenticationService));\r\nexport { AuthenticationService };\r\n//# sourceMappingURL=authentication.service.js.map","references":["/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@angular/core@8.2.14_rxjs@6.5.4+zone.js@0.9.1/node_modules/@angular/core/core.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedittools/common/temp/node_modules/.pnpm/@types/lodash@4.14.159/node_modules/@types/lodash/ts3.1/index.d.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/components/login-dialog/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/constants.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/dtos/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/interfaces/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/utils/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/translations/index.ts","/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/src/services/authentication/sso-authentication.helper.ts"],"map":"{\"version\":3,\"file\":\"authentication.service.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../src/services/authentication/authentication.service.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/sandeepkalpane/Data/hybris2105/hybris/bin/modules/smartedit/smartedit/apps/smart-utils/services/authentication/authentication.service.d.ts","writeByteOrderMark":false,"text":"/**\r\n * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.\r\n * @module smartutils\r\n */\r\nimport { IAuthenticationManagerService, IAuthenticationService, ICredentialsMapRecord, IEventService, ILoginData, IModalService, ISettingsService, ISharedDataService, IStorageService } from '../../interfaces';\r\nimport { ITranslationsFetchService } from '../translations';\r\nimport { SSOAuthenticationHelper } from './sso-authentication.helper';\r\nexport interface ICredentialsMap {\r\n    [entryPoint: string]: ICredentialsMapRecord;\r\n}\r\nexport interface IAuthMap {\r\n    [entryPoint: string]: string;\r\n}\r\nexport declare class AuthenticationService extends IAuthenticationService {\r\n    protected translationsFetchService: ITranslationsFetchService;\r\n    protected modalService: IModalService;\r\n    protected sharedDataService: ISharedDataService;\r\n    protected storageService: IStorageService;\r\n    protected eventService: IEventService;\r\n    protected ssoAuthenticationHelper: SSOAuthenticationHelper;\r\n    protected settingsService: ISettingsService;\r\n    protected authenticationManager: IAuthenticationManagerService;\r\n    constructor(translationsFetchService: ITranslationsFetchService, modalService: IModalService, sharedDataService: ISharedDataService, storageService: IStorageService, eventService: IEventService, ssoAuthenticationHelper: SSOAuthenticationHelper, settingsService: ISettingsService, authenticationManager: IAuthenticationManagerService);\r\n    filterEntryPoints(resource: string): Promise<string[]>;\r\n    isAuthEntryPoint(resource: string): Promise<boolean>;\r\n    authenticate(resource: string): Promise<void>;\r\n    logout(): Promise<void>;\r\n    isReAuthInProgress(entryPoint: string): Promise<boolean>;\r\n    setReAuthInProgress(entryPoint: string): Promise<void>;\r\n    isAuthenticated(url: string): Promise<boolean>;\r\n    protected _findLoginData(resource: string): Promise<ILoginData>;\r\n    protected _launchAuth(loginData: ILoginData): Promise<any>;\r\n}\r\n"}}
